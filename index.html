<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Markerless AR with A-Frame & WebXR</title>
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- WebXR Hit Test Component for A-Frame -->
  <script src="https://unpkg.com/aframe-ar-hit-test-component/dist/aframe-ar-hit-test-component.min.js"></script>
  <style>
    body, html { margin: 0; overflow: hidden; }
    #enter-ar {
      position: absolute; top: 10px; left: 10px;
      padding: 8px 12px; font-size: 16px;
      background: rgba(255,255,255,0.8);
      border: none; border-radius:4px;
      z-index: 2;
    }
  </style>
</head>
<body>
  <button id="enter-ar">進入 AR</button>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    webxr="optionalFeatures: hit-test; requiredFeatures: hit-test">

    <!-- Hit Test Source -->
    <a-entity webxr-hit-test="targetRayMode: screen;"></a-entity>

    <!-- 預先隱藏，等放置後才顯示 -->
    <a-entity id="model" 
              gltf-model="model.glb"
              scale="0.3 0.3 0.3"
              visible="false"
              ar-hit-test>
    </a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const enterAR = document.getElementById('enter-ar');
    const scene   = document.querySelector('a-scene');
    const model   = document.getElementById('model');
    let recorder, recorded = [];

    enterAR.addEventListener('click', () => {
      scene.renderer.xr.enabled = true;
      scene.enterVR();  // 進入 WebXR AR 模式
    });

    // 放置模型：使用 ar-hit-test 組件自動做位姿偵測
    model.addEventListener('hit-test-select', () => {
      model.setAttribute('visible', true);
      // 開始錄製
      const canvas = scene.renderer.domElement;
      const stream = canvas.captureStream(30);
      recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
      recorded = [];
      recorder.ondataavailable = e => { if(e.data.size) recorded.push(e.data); };
      recorder.onstop = () => {
        const blob = new Blob(recorded, { type: 'video/webm' });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url; a.download = 'ar_output.webm';
        a.click(); URL.revokeObjectURL(url);
      };
      recorder.start();
    });

    // 退出 AR 時自動停止錄製
    scene.renderer.xr.getSession()?.addEventListener('end', () => {
      if (recorder && recorder.state === 'recording') recorder.stop();
    });
  </script>
</body>
</html>
